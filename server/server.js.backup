const express = require('express');
const cors = require('cors');
const { sql, poolPromise } = require('./db');
const {
    ensureSecurityTables,
    loginUser,
    authMiddleware,
    verifyTokenValid,
    verifyAdminPassword,
    getAllUsers,
    createUser,
    updateUser,
    deleteUser
} = require('./auth');
const { sendPasswordEmail, verifyEmailService } = require('./emailService');

const app = express();
const port = 3000;

app.use(cors());
app.use(express.json());

// Initialize security tables on startup
ensureSecurityTables();

// ==========================================
// AUTH ENDPOINTS (public)
// ==========================================

// POST /api/auth/login - Login with email + PIN
app.post('/api/auth/login', async (req, res) => {
    try {
        const { email, clave } = req.body;
        if (!email) {
            return res.status(400).json({ error: 'Email es requerido' });
        }
        if (!clave) {
            return res.status(400).json({ error: 'Clave es requerida' });
        }
        const result = await loginUser(email.trim().toLowerCase(), clave.trim());
        if (!result.success) {
            return res.status(401).json({ error: result.message });
        }
        res.json(result);
    } catch (err) {
        console.error('Error in /api/auth/login:', err);
        res.status(500).json({ error: err.message });
    }
});

// POST /api/auth/verify - Verify JWT token is still valid (checks PIN hasn't changed)
app.post('/api/auth/verify', authMiddleware, async (req, res) => {
    try {
        const isValid = await verifyTokenValid(req.user);
        if (!isValid) {
            return res.status(401).json({ error: 'Sesi칩n inv치lida. La clave fue cambiada o el usuario fue eliminado.' });
        }
        res.json({ valid: true, user: req.user });
    } catch (err) {
        res.status(401).json({ error: 'Error verificando sesi칩n' });
    }
});

// POST /api/auth/send-password - Send password to user's email
app.post('/api/auth/send-password', async (req, res) => {
    try {
        const { email } = req.body;
        if (!email) {
            return res.status(400).json({ error: 'Email es requerido' });
        }

        // Get user from database
        const pool = await poolPromise;
        const result = await pool.request()
            .input('email', sql.NVarChar, email.trim().toLowerCase())
            .query('SELECT Email, Nombre, Clave FROM APP_USUARIOS WHERE Email = @email AND Activo = 1');

        if (result.recordset.length === 0) {
            return res.status(404).json({ error: 'Usuario no encontrado' });
        }

        const user = result.recordset[0];

        // Send email
        const emailSent = await sendPasswordEmail(user.Email, user.Clave, user.Nombre);

        if (emailSent) {
            res.json({ success: true, message: 'Clave enviada al correo' });
        } else {
            res.status(500).json({ error: 'Error al enviar el correo. Intenta de nuevo.' });
        }
    } catch (err) {
        console.error('Error in /api/auth/send-password:', err);
        res.status(500).json({ error: err.message });
    }
});

// ==========================================
// ADMIN ENDPOINTS (protected by admin password)
// ==========================================

// POST /api/admin/verify - Verify admin password
app.post('/api/admin/verify', (req, res) => {
    const { password } = req.body;
    if (verifyAdminPassword(password)) {
        res.json({ success: true });
    } else {
        res.status(401).json({ error: 'Clave incorrecta' });
    }
});

// GET /api/admin/users - List all users
app.get('/api/admin/users', async (req, res) => {
    try {
        const { adminPassword } = req.query;
        if (!verifyAdminPassword(adminPassword)) {
            return res.status(401).json({ error: 'Clave de administrador incorrecta' });
        }
        const users = await getAllUsers();
        res.json(users);
    } catch (err) {
        console.error('Error in /api/admin/users:', err);
        res.status(500).json({ error: err.message });
    }
});

// POST /api/admin/users - Create a user
app.post('/api/admin/users', async (req, res) => {
    try {
        const { adminPassword, email, nombre, clave, stores } = req.body;
        if (!verifyAdminPassword(adminPassword)) {
            return res.status(401).json({ error: 'Clave de administrador incorrecta' });
        }
        const result = await createUser(email.trim().toLowerCase(), nombre, clave, stores);
        res.json({ success: true, userId: result.userId, clave: result.clave });
    } catch (err) {
        console.error('Error creating user:', err);
        if (err.message.includes('UNIQUE') || err.message.includes('duplicate')) {
            res.status(400).json({ error: 'El email ya est치 registrado' });
        } else {
            res.status(500).json({ error: err.message });
        }
    }
});

// PUT /api/admin/users/:id - Update a user
app.put('/api/admin/users/:id', async (req, res) => {
    try {
        const { adminPassword, email, nombre, activo, clave, stores } = req.body;
        if (!verifyAdminPassword(adminPassword)) {
            return res.status(401).json({ error: 'Clave de administrador incorrecta' });
        }
        await updateUser(parseInt(req.params.id), email.trim().toLowerCase(), nombre, activo, clave, stores);
        res.json({ success: true });
    } catch (err) {
        console.error('Error updating user:', err);
        res.status(500).json({ error: err.message });
    }
});

// DELETE /api/admin/users/:id - Delete a user
app.delete('/api/admin/users/:id', async (req, res) => {
    try {
        const { adminPassword } = req.query;
        if (!verifyAdminPassword(adminPassword)) {
            return res.status(401).json({ error: 'Clave de administrador incorrecta' });
        }
        await deleteUser(parseInt(req.params.id));
        res.json({ success: true });
    } catch (err) {
        console.error('Error deleting user:', err);
        res.status(500).json({ error: err.message });
    }
});

// ==========================================
// DATA ENDPOINTS (protected by auth)
// ==========================================

// GET /api/budget?year=2026&local=...&canal=Todos&tipo=Ventas
app.get('/api/budget', authMiddleware, async (req, res) => {
    try {
        const pool = await poolPromise;
        const year = parseInt(req.query.year) || 2026;
        const local = req.query.local;
        const canal = req.query.canal || 'Todos';
        const tipo = req.query.tipo || 'Ventas';

        if (!local) {
            return res.status(400).json({ error: 'El par치metro local es requerido' });
        }

        // Check user permissions for requested store
        const userStores = req.user.allowedStores || [];
        if (userStores.length > 0 && !userStores.includes(local)) {
            return res.status(403).json({ error: 'No tiene acceso a este local' });
        }

        const query = `SELECT Fecha, A침o, Mes, Dia, Local, Canal, Tipo,
            MontoReal, Monto, Monto_Acumulado, 
            MontoAnterior, MontoAnterior_Acumulado, 
            MontoAnteriorAjustado, MontoAnteriorAjustado_Acumulado
            FROM RSM_ALCANCE_DIARIO 
            WHERE A침o = @year AND Local = @local AND Canal = @canal AND Tipo = @tipo
            ORDER BY Mes, Dia`;
        const request = pool.request()
            .input('year', sql.Int, year)
            .input('local', sql.NVarChar, local)
            .input('canal', sql.NVarChar, canal)
            .input('tipo', sql.NVarChar, tipo);

        const result = await request.query(query);
        res.json(result.recordset);
    } catch (err) {
        console.error('Error in /api/budget:', err);
        res.status(500).json({ error: err.message });
    }
});

// GET /api/stores - Return stores and groups user has access to
app.get('/api/stores', authMiddleware, async (req, res) => {
    console.log('游늸 /api/stores called by user:', req.user?.email);
    try {
        const pool = await poolPromise;
        const userStores = req.user.allowedStores || [];

        // First, get oficial group names from GRUPOSALMACENCAB table
        const groupNamesQuery = `
            SELECT DISTINCT NombreGrupo 
            FROM GRUPOSALMACENCAB 
            WHERE CODVISIBLE = 20
        `;

        const groupNamesResult = await pool.request().query(groupNamesQuery);
        const officialGroupNames = new Set(groupNamesResult.recordset.map(r => r.NombreGrupo));
        console.log('游늶 Official group names from GRUPOSALMACENCAB:', Array.from(officialGroupNames));

        // Then get all locals from budget data
        let localsQuery = 'SELECT DISTINCT Local FROM RSM_ALCANCE_DIARIO WHERE A침o = 2026';

        if (userStores.length > 0) {
            // User has specific store permissions
            const request = pool.request();
            const storeList = userStores.map((s, i) => `@store${i}`).join(', ');

            localsQuery += ` AND Local IN (${storeList})`;

            userStores.forEach((store, i) => {
                request.input(`store${i}`, sql.NVarChar, store);
            });

            localsQuery += ' ORDER BY Local';

            const result = await request.query(localsQuery);
            const allLocals = result.recordset.map(r => r.Local);

            // Separate based on official group names
            const groups = allLocals.filter(local => officialGroupNames.has(local));
            const individuals = allLocals.filter(local => !officialGroupNames.has(local));

            res.json({ groups, individuals });
        } else {
            // User has access to all stores
            localsQuery += ' ORDER BY Local';

            const result = await pool.request().query(localsQuery);
            const allLocals = result.recordset.map(r => r.Local);

            // Separate based on official group names
            const groups = allLocals.filter(local => officialGroupNames.has(local));
            const individuals = allLocals.filter(local => !officialGroupNames.has(local));

            res.json({ groups, individuals });
        }
    } catch (err) {
        console.error('Error in /api/stores:', err);
        res.status(500).json({ error: err.message });
    }
});

// TEST endpoint - remove after debugging
app.get('/api/test-stores', async (req, res) => {
    try {
        const pool = await poolPromise;
        const query = 'SELECT DISTINCT Local FROM RSM_ALCANCE_DIARIO WHERE A침o = 2026 ORDER BY Local';
        const result = await pool.request().query(query);
        const allLocals = result.recordset.map(r => r.Local);

        const groups = allLocals.filter(local =>
            local.toLowerCase().startsWith('zona') ||
            local.toLowerCase().includes('corporativo') ||
            local.toLowerCase().includes('sss')
        );
        const individuals = allLocals.filter(local => !groups.includes(local));

        res.json({
            success: true,
            total: allLocals.length,
            groups: groups,
            individuals: individuals
        });
    } catch (err) {
        res.status(500).json({ error: err.message, stack: err.stack });
    }
});

// GET /api/all-stores - Return ALL stores (for admin panel)
app.get('/api/all-stores', async (req, res) => {
    try {
        const { adminPassword } = req.query;
        if (!verifyAdminPassword(adminPassword)) {
            return res.status(401).json({ error: 'Clave de administrador incorrecta' });
        }
        const pool = await poolPromise;
        const result = await pool.request()
            .query('SELECT DISTINCT Local FROM RSM_ALCANCE_DIARIO WHERE A칌O = 2026 ORDER BY Local');
        const stores = result.recordset.map(r => r.Local);
        res.json(stores);
    } catch (err) {
        console.error('Error in /api/all-stores:', err);
        res.status(500).json({ error: err.message });
    }
});

// GET /api/columns - Debug endpoint
app.get('/api/columns', async (req, res) => {
    try {
        const pool = await poolPromise;
        const result = await pool.request()
            .query("SELECT TOP 1 * FROM RSM_ALCANCE_DIARIO WHERE A칌O = 2026");

        if (result.recordset.length > 0) {
            res.json({
                columns: Object.keys(result.recordset[0]),
                sample: result.recordset[0]
            });
        } else {
            res.json({ columns: [], sample: null });
        }
    } catch (err) {
        console.error('Error in /api/columns:', err);
        res.status(500).json({ error: err.message });
    }
});

app.listen(port, () => {
    console.log(`游 Server running at http://localhost:${port}`);
});
